<html>
  <!-- test with this video -->
  <!-- src="https://www.youtube.com/embed/82TD06U4ppA?enablejsapi=1" -->

  <head>
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"></script>
  </head>
  <body>
    <iframe id="notiplay-iframe"
            width="640" height="360"
            src="https://www.youtube.com/embed/5Svp9E5orvw?enablejsapi=1"
            enablejsapi="1"
            frameborder="0">
    </iframe>

    <script type="text/javascript">
     var tag = document.createElement('script');
     tag.id = 'iframe-demo';
     tag.src = 'https://www.youtube.com/iframe_api';

     var firstScriptTag = document.getElementsByTagName('script')[0];
     firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
     
     var ytk = "AIzaSyCrT-HRrkCwFSwdg3ETJbCMB-GffhNVJfM";
     var videoId = '5Svp9E5orvw';
     var player;
     var playerStats = {
       ready: false,
       readyCallables: []
     };

     var notiStorage = {
       videoId:  '5Svp9E5orvw',
       playHistory: [videoId],
       playIndex: 0,
       isPlaybackInHistory: false,
     };
     
     try {
       if (NotiPlay) {}
     } catch(e) {
       NotiPlay = false;
     }
     
     function onYouTubeIframeAPIReady() {
       player = new YT.Player('notiplay-iframe', {
         events: {
           'onReady': onPlayerReady,
           'onStateChange': onPlayerStateChange,
           'onPlaybackQualityChange': onPlaybackQualityChange,
           'onPlaybackRateChange': onPlaybackRateChange,
           'onError': onError,
           
         }
       });
     }
     
     function onPlayerReady(event) {
       playerStats.ready = true;
       playerStats.readyCallables.forEach(function(c){
         c();
       });
       playerStats.readyCallables = [];

       if (NotiPlay) {
         NotiPlay.onPlayerReady();
       }
       
       setInterval(function(){
         var t = player.getCurrentTime();
         t = Math.round(t);
         if (NotiPlay) {
           NotiPlay.onPlaybackPositionUpdate(t);
         }
       }, 2000);
       
     }

     function onPlayerStateChange(event) {
       if (NotiPlay) {
         NotiPlay.onPlayerStateChange(event.data);
       }
     }

     function onPlaybackQualityChange(event) {
       if (NotiPlay) {
         var arg = event.data;

         NotiPlay.onPlaybackQualityChange(arg);
       }
     }

     function onPlaybackRateChange(event) {
       if (NotiPlay) {
         NotiPlay.onPlaybackRateChange(event.data);
       }
     }

     function onError(event) {
       if (NotiPlay) {
         NotiPlay.onErrorCode(event.data);
       }
     }

     
     function _runWhenPlayerReady(callable) {
       if (!playerStats.ready) {
         playerStats.readyCallables.push(callable);
       } else {
         callable();
       };
     }

     
     function _fetchVideoData(callback) {
       $.get("https://www.googleapis.com/youtube/v3/videos?part=snippet&id=" +
             window.videoId + "&key=" + ytk, function(data) {
               if (callback) {
                 callback(data);
               } else {
                 console.log(data);
               }
             });
     }

     function _getRelatedVideo(callback) {
       var id = window.videoId;
       var url = "https://www.googleapis.com/youtube/v3/search?part=snippet&relatedToVideoId=" +
                 id + "&type=video&key=" + ytk;

       $.get(url, function(data) {
         var relatedVideos = [];

         if (data && data.items) {
           data.items.forEach(function(item) {
             var vId = item.id.videoId;
             var snippet = item.snippet;

             relatedVideos.push({
               id: vId,
               snippet: snippet
             });
           });
         }
         if (callback) {
           callback(relatedVideos);
         } else {
           console.log(data);
           console.log(relatedVideos);
         }
       });
     }

     function playWithVideoId(videoId) {
       window.videoId = videoId;
       notiStorage.videoId = videoId;
       if (!notiStorage.isPlaybackInHistory) {
         notiStorage.playIndex = notiStorage.playHistory.length - 1;
         notiStorage.playHistory.push(videoId);
       }
       
       _runWhenPlayerReady(function() {
         player.loadVideoById(videoId);
         getVideoData();
       });
     }

     function playerPlay() {
       _runWhenPlayerReady(function() {
         player.playVideo();
       });

     }

     function seekTo(timeInSeconds) {
       _runWhenPlayerReady(function() {
         try{
           player.seekTo(timeInSeconds, true);
         } catch(e) {};
       });
     }

     function seekForward(seconds) {
       if (!seconds) {
         seconds = 30;
       }

       try{
         var t = player.getCurrentTime();
         t = t + seconds;
         t = Math.round(t);
         player.seekTo(t, true);
       } catch(e) {};
     }

     function seekBackward(seconds) {
       if (!seconds) {
         seconds = 30;
       }

       try{
         var t = player.getCurrentTime();
         t = t - seconds;
         t = Math.round(t);

         if (t < 0) {
           t = 0;
         }
         
         player.seekTo(t, true);
       } catch(e) {};
     }

     function playerPause(){
       try{
         player.pauseVideo();
       } catch(e) {};
     }

     function playerStop() {
       try{
         player.stopVideo();
       } catch(e) {};
     }

     function playerNextVideo() {
       if (notiStorage.isPlaybackInHistory
           && notiStorage.playIndex < notiStorage.playHistory.length - 1) {
         
         notiStorage.playIndex += 1;
         var id = notiStorage.playHistory[notiStorage.playIndex];
         playWithVideoId(id);
       } else {
         
         notiStorage.isPlaybackInHistory = false;
         try{
           _getRelatedVideo(function(data) {
             if (data.length < 1) return;
             var video;
             data.forEach(function(d) {
               if (!video && notiStorage.playHistory.indexOf(d.id) == -1) {
                 video = d;
               }
             });
             if (!video) video = data[0];
             playWithVideoId(video.id);
           });
         } catch(e) {};
       }
     }

     function playerPreviousVideo() {
       notiStorage.isPlaybackInHistory = true;
       if (notiStorage.playIndex == 0) {
         console.log("cant go further back, beginning reached");
         return;
       }
       notiStorage.playIndex = notiStorage.playIndex - 1;
       var id = notiStorage.playHistory[notiStorage.playIndex];
       playWithVideoId(id);
     }

     function getVideoData() {
       _fetchVideoData(function(data) {
         var snippet = data.items[0].snippet;
         var title = snippet.title;
         var thumbnail = snippet.thumbnails.maxres.url;

         if (NotiPlay) {
           NotiPlay.onVideoData(title, thumbnail);
         }
       });
     }
     
     function getPlaybackPosition() {
       try {
         var t = player.getCurrentTime();
         t = Math.round(t);
         if (NotiPlay) {
           NotiPlay.onPlaybackPosition(t);
         }
       }catch(e) {}
     }


    </script>
  </body>
</html>
